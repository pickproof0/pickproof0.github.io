<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pickproof Marketplace</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f8f9fa; color: #333;}
    .rainbow-text {background: linear-gradient(90deg, #ff2d2d, #ff8a2d, #ffff2d, #2dff2d, #2dffff, #2d2dff, #8a2dff); -webkit-background-clip: text; background-clip: text; color: transparent;}
    .star { color: #f59e42; font-size: 1.1em; }
    .star-empty { color: #e5e7eb; font-size: 1.1em;}
    .product-card:hover { box-shadow: 0 10px 25px rgba(0,0,0,.12);}
    .admin-actions button {margin-left: 0.25rem;}
  </style>
</head>
<body>
<nav class="bg-white shadow-md"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between h-16 items-center">
  <h1 class="text-xl font-bold rainbow-text">Pickproof</h1>
  <button id="adminToggle" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium" onclick="toggleAdminPanel()">Admin Panel</button>
</div></nav>
<div class="rainbow-gradient">
  <div class="max-w-7xl mx-auto py-8 text-center">
    <h1 class="text-4xl font-extrabold tracking-tight text-gray-900">Discover Amazing Products</h1>
    <p class="mt-6 text-xl text-gray-800 max-w-3xl mx-auto">Curated collections of the best products handpicked just for you</p>
  </div>
</div>
<div class="max-w-7xl mx-auto px-4 py-8" id="productsSection">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold rainbow-text">All Products</h2>
    <input type="text" id="searchBox" class="border rounded px-2 py-1" placeholder="Search products..." oninput="searchProducts(this.value)">
  </div>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="allProducts"></div>
</div>
<!-- Admin Panel (Sidebar) -->
<div id="adminPanel" class="fixed inset-y-0 right-0 w-full max-w-md bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto">
  <div class="p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-lg font-medium rainbow-text" id="adminFormTitle">Add New Product</h3>
      <button onclick="toggleAdminPanel()" class="text-gray-500 hover:text-gray-700" aria-label="Close admin panel"><i class="fas fa-times"></i></button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Affiliate Link</label>
        <div class="flex mt-1">
          <input type="text" id="affiliateLink" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Paste product link...">
          <button type="button" onclick="autoFillFromLink()" class="ml-2 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">Auto-Fill</button>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-900">Product Image</label>
        <div class="flex items-center">
          <input type="file" id="productImage" class="block w-full text-sm text-gray-900 border border-gray-300 rounded cursor-pointer focus:outline-none" accept="image/*" onchange="previewImage(this)">
        </div>
        <div class="mt-2 flex justify-center" id="imagePreviewContainer" style="display: none;">
          <img id="imagePreview" src="#" alt="Product image preview" class="h-32 object-contain" />
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-800">Product Title</label>
        <input type="text" id="productTitle" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm text-gray-700 bg-white">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Product Description</label>
        <textarea id="productDescription" rows="3" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm text-gray-900"></textarea>
      </div>
      <div class="flex space-x-2">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700">Price</label>
          <input type="number" id="productPrice" min="0" step="0.01" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Currency</label>
          <select id="productCurrency" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            <option value="$">USD ($)</option>
            <option value="€">EUR (€)</option>
            <option value="£">GBP (£)</option>
            <option value="₹">INR (₹)</option>
            <option value="¥">JPY (¥)</option>
            <option value="₩">KRW (₩)</option>
            <option value="₽">RUB (₽)</option>
            <option value="C$">CAD (C$)</option>
            <option value="A$">AUD (A$)</option>
            <option value="Fr">CHF (Fr)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Rating</label>
          <select id="productRating" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            <option value="5">★★★★★ (5)</option>
            <option value="4">★★★★☆ (4)</option>
            <option value="3">★★★☆☆ (3)</option>
            <option value="2">★★☆☆☆ (2)</option>
            <option value="1">★☆☆☆☆ (1)</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Category</label>
        <select id="productCategory" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></select>
      </div>
      <div class="flex justify-end space-x-2">
        <button type="button" class="px-4 py-2 text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700" onclick="addOrUpdateProduct()" id="addProductBtn" style="display:none;">Add Product</button>
        <button type="button" class="px-4 py-2 text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700" onclick="addOrUpdateProduct()" id="updateProductBtn" style="display:none;">Update Product</button>
        <button type="button" class="px-3 py-2 border border-gray-400 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-gray-100 hover:bg-gray-200" onclick="cancelEdit()" id="cancelEditBtn" style="display:none;">Cancel</button>
      </div>
    </div>
    <div class="mt-8">
      <h4 class="font-medium mb-3 rainbow-text">Manage Categories</h4>
      <div class="flex items-center space-x-2 mb-2">
        <input type="text" id="newCategory" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="New category">
        <button type="button" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm" onclick="addCategory()" id="addCategoryBtn" style="display:none;">Add</button>
      </div>
      <ul id="categoriesListAdmin" class="space-y-2"></ul>
    </div>
  </div>
</div>
<script>
function getStored(key, fallback) { let item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback;}
function setStored(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
let products = [];
let categories = [];
let filteredProducts = null;
let isAdmin = false;
let editProductId = null;

document.addEventListener('DOMContentLoaded', function() {
  isAdmin = sessionStorage.getItem('isAdmin') === 'true';
  categories = getStored('pickproofCategories', ["Electronics","Fitness","Home","Fashion","Beauty","Kitchen"]);
  products = getStored('pickproofProducts', []);
  renderCategoriesAdmin();
  renderProducts();
  setupAdminUI();
});

function setupAdminUI() {
  document.getElementById('adminToggle').style.display = 'block';
  document.getElementById('addProductBtn').style.display = isAdmin && !editProductId ? 'inline-flex' : 'none';
  document.getElementById('addCategoryBtn').style.display = isAdmin ? 'inline-flex' : 'none';
  document.getElementById('updateProductBtn').style.display = (isAdmin && editProductId) ? 'inline-flex' : 'none';
  document.getElementById('cancelEditBtn').style.display = (isAdmin && editProductId) ? 'inline-flex' : 'none';
  document.getElementById('adminFormTitle').textContent = editProductId ? "Edit Product" : "Add New Product";
  renderCategoriesAdmin();
  renderCategorySelect();
  if (!isAdmin) {
    document.getElementById('adminPanel').classList.add('translate-x-full');
    document.getElementById('adminPanel').classList.remove('translate-x-0');
  }
}

function toggleAdminPanel() {
  if (!isAdmin) {
    const input = prompt("Enter admin password:");
    if (input === "pickproof123") {
      isAdmin = true;
      sessionStorage.setItem('isAdmin', 'true');
      setupAdminUI(); alert('Admin access granted.');
    } else { alert("Incorrect password!"); return; }
  }
  const panel = document.getElementById('adminPanel');
  const isHidden = panel.classList.contains('translate-x-full');
  panel.classList.toggle('translate-x-full', !isHidden);
  panel.classList.toggle('translate-x-0', isHidden);
  document.getElementById('adminToggle').textContent = isHidden ? 'Close Admin' : 'Admin Panel';
}

function previewImage(input) {
  const previewContainer = document.getElementById('imagePreviewContainer');
  const preview = document.getElementById('imagePreview');
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) { preview.src = e.target.result; previewContainer.style.display = 'block'; }
    reader.readAsDataURL(input.files[0]);
  } else { previewContainer.style.display = 'none'; }
}

function addOrUpdateProduct() {
  if (!isAdmin) return;
  const title = document.getElementById('productTitle').value.trim();
  const description = document.getElementById('productDescription').value.trim();
  const category = document.getElementById('productCategory').value;
  const affiliateLink = document.getElementById('affiliateLink').value.trim();
  const price = parseFloat(document.getElementById('productPrice').value);
  const currency = document.getElementById('productCurrency').value;
  const rating = parseInt(document.getElementById('productRating').value);
  const imageInput = document.getElementById('productImage');
  let imageSrc = 'https://via.placeholder.com/300x300?text=No+Image';
  if (imageInput.files[0]) imageSrc = document.getElementById('imagePreview').src;
  else if (document.getElementById('imagePreview').src && document.getElementById('imagePreview').src.startsWith("http")) imageSrc = document.getElementById('imagePreview').src;
  if (!title || !description || !category || !affiliateLink || isNaN(price) || !currency || isNaN(rating)) { alert('Please fill in all required fields'); return; }

  if (editProductId) {
    let idx = products.findIndex(p => p.id === editProductId);
    if (idx > -1) {
      if (!imageInput.files[0] && products[idx].image) imageSrc = products[idx].image;
      products[idx] = { ...products[idx], title, description, image: imageSrc, category, affiliateLink, price, currency, rating };
      setStored('pickproofProducts', products); renderProducts(); alert('Product updated!');
    }
    cancelEdit();
  } else {
    const newProduct = { id: Date.now(), title, description, image: imageSrc, category, affiliateLink, price, currency, rating, dateAdded: new Date().toISOString() };
    products.push(newProduct); setStored('pickproofProducts', products); renderProducts(); alert('Product added!');
    resetProductForm();
  }
}

function resetProductForm() {
  document.getElementById('productTitle').value = '';
  document.getElementById('productDescription').value = '';
  document.getElementById('affiliateLink').value = '';
  document.getElementById('productPrice').value = '';
  document.getElementById('productCurrency').value = '$';
  document.getElementById('productRating').value = '5';
  document.getElementById('productCategory').selectedIndex = 0;
  document.getElementById('imagePreviewContainer').style.display = 'none';
  document.getElementById('productImage').value = '';
}

function startEditProduct(productId) {
  editProductId = productId;
  const p = products.find(prod => prod.id === productId); if (!p) return;
  document.getElementById('productTitle').value = p.title;
  document.getElementById('productDescription').value = p.description;
  document.getElementById('affiliateLink').value = p.affiliateLink;
  document.getElementById('productPrice').value = p.price;
  document.getElementById('productCurrency').value = p.currency || '$';
  document.getElementById('productRating').value = p.rating || 5;
  document.getElementById('productCategory').value = p.category;
  document.getElementById('imagePreview').src = p.image;
  document.getElementById('imagePreviewContainer').style.display = 'block';
  document.getElementById('productImage').value = '';
  setupAdminUI();
  const panel = document.getElementById('adminPanel');
  if (panel.classList.contains('translate-x-full')) toggleAdminPanel();
}

function cancelEdit() { editProductId = null; resetProductForm(); setupAdminUI(); }

function deleteProduct(productId) {
  if (!isAdmin) return;
  if (confirm("Are you sure you want to delete this product?")) {
    products = products.filter(p => p.id !== productId);
    setStored('pickproofProducts', products); renderProducts(); alert("Product deleted.");
  }
  cancelEdit();
}

function addCategory() {
  if (!isAdmin) return;
  const newCategory = document.getElementById('newCategory').value.trim();
  if (!newCategory) {alert('Enter a category name');return;}
  if (categories.includes(newCategory)) {alert('This category already exists');return;}
  categories.push(newCategory); setStored('pickproofCategories', categories);
  renderCategoriesAdmin(); renderCategorySelect();
  document.getElementById('newCategory').value = '';
  alert('Category added!');
}

function deleteCategory(category) {
  if (!isAdmin) return;
  if (confirm(`Are you sure you want to delete "${category}"?`)) {
    categories = categories.filter(c => c !== category);
    products.forEach(product => { if (product.category === category) product.category = "Uncategorized"; });
    if (!categories.includes("Uncategorized")) categories.push("Uncategorized");
    setStored('pickproofCategories', categories); setStored('pickproofProducts', products);
    renderCategoriesAdmin(); renderCategorySelect(); renderProducts();
  }
}

function renderCategoriesAdmin() {
  const categoriesList = document.getElementById('categoriesListAdmin');
  categoriesList.innerHTML = '';
  categories.forEach(category => {
    const li = document.createElement('li');
    li.className = 'flex justify-between items-center bg-gray-50 px-3 py-2 rounded';
    li.innerHTML = `<span>${category}</span>${isAdmin ? `<button class="text-red-500 hover:text-red-700" onclick="deleteCategory('${category}')"><i class="fas fa-trash"></i></button>` : ''}`;
    categoriesList.appendChild(li);
  });
  renderCategorySelect();
}
function renderCategorySelect() {
  const sel = document.getElementById('productCategory');
  sel.innerHTML = '';
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    sel.appendChild(option);
  });
}

function renderProducts() {
  const allProductsContainer = document.getElementById('allProducts');
  allProductsContainer.innerHTML = '';
  let showProducts = filteredProducts || products;
  showProducts.forEach(product => allProductsContainer.appendChild(createProductCard(product)));
}
function createProductCard(product) {
  const card = document.createElement('div');
  card.className = 'product-card bg-white rounded-lg overflow-hidden shadow-sm flex flex-col';
  card.innerHTML = `
    <div class="p-4 flex flex-col h-full">
      <div class="aspect-w-1 aspect-h-1 bg-gray-100 rounded-lg overflow-hidden">
        <img src="${product.image}" alt="${product.title} image" class="w-full h-48 object-contain" onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
      </div>
      <div class="mt-4 flex-1 flex flex-col">
        <h3 class="text-lg font-medium text-gray-800 truncate-1" title="${product.title}">${product.title}</h3>
        <div class="flex items-center mt-1 mb-1">${renderStars(product.rating)}<span class="ml-2 text-xs text-gray-500">(${product.rating || 'N/A'})</span></div>
        <p class="text-sm text-gray-700 truncate-2" title="${product.description}">${product.description}</p>
        <div class="mt-2 flex justify-between items-center">
          <span class="text-xs px-2 py-1 bg-gray-100 rounded-full">${product.category}</span>
          <span class="text-sm font-semibold text-indigo-700">${product.currency || '$'}${product.price !== undefined ? Number(product.price).toFixed(2) : 'N/A'}</span>
        </div>
        <div class="mt-4 flex justify-end admin-actions">
          <a href="${product.affiliateLink}" target="_blank" rel="noopener" class="text-sm font-medium text-white px-3 py-1 rounded product-btn mr-2" aria-label="View deal for ${product.title}">View Deal</a>
          ${isAdmin ? `<button title="Edit" class="text-blue-600 hover:text-blue-800" onclick="startEditProduct(${product.id})"><i class="fas fa-edit"></i></button>
          <button title="Delete" class="text-red-600 hover:text-red-800" onclick="deleteProduct(${product.id})"><i class="fas fa-trash"></i></button>` : ''}
        </div>
      </div>
    </div>
  `;
  return card;
}
function renderStars(rating) {
  rating = rating || 0;
  return '<span>' + '<i class="fas fa-star star"></i>'.repeat(rating) + '<i class="fas fa-star star-empty"></i>'.repeat(5-rating) + '</span>';
}
function searchProducts(query) {
  query = (query || '').toLowerCase();
  if (!query) filteredProducts = null;
  else filteredProducts = products.filter(p => p.title.toLowerCase().includes(query) || p.description.toLowerCase().includes(query) || p.category.toLowerCase().includes(query));
  renderProducts();
}

// ----------- AUTO-FILL FROM LINK (Microlink.io) -----------
async function autoFillFromLink() {
  const url = document.getElementById('affiliateLink').value.trim();
  if (!url) return alert('Paste a product/affiliate link first!');
  try {
    document.getElementById('affiliateLink').disabled = true;
    const resp = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}&meta=true&audio=false&video=false`);
    const data = await resp.json();
    if (data.status !== 'success' || !data.data) throw "No data";
    // Title
    if (data.data.title) document.getElementById('productTitle').value = data.data.title;
    // Description
    if (data.data.description) document.getElementById('productDescription').value = data.data.description;
    // Image
    if (data.data.image && data.data.image.url) {
      document.getElementById('imagePreview').src = data.data.image.url;
      document.getElementById('imagePreviewContainer').style.display = 'block';
    }
    // Price
    if (data.data.price && !isNaN(Number(data.data.price.replace(/[^0-9.]/g,"")))) {
      document.getElementById('productPrice').value = Number(data.data.price.replace(/[^0-9.]/g,""));
      // Try to guess currency
      let currencySymbol = data.data.price.replace(/[0-9.,\s]/g,'').trim();
      if (currencySymbol) document.getElementById('productCurrency').value = currencySymbol;
    }
    alert('Auto-fill complete! Please review/edit fields before saving.');
  } catch(e) {
    alert('Could not auto-fill. Please fill fields manually.');
  } finally {
    document.getElementById('affiliateLink').disabled = false;
  }
}
</script>
</body>
</html>
